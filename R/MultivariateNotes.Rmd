---
title: "Multilevel regression"
author: "Chris Stantis"
date: '2022-12-02'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse); library(leaps)
```

# Intro
God help me, if I write this out I stand a chance of remembering what I've done. 

# Setup
Run G8(Fixed) to get multivariate dataset, which has scraped a bunch of the independent variables. 

Then, import tapData and remove the Hawaiian samples using the chunk below.   
```{r import, include = F}
setwd("~/GitHub/CityWater")
tapData <- read.csv("data/cityWater.csv", na.strings = "NA")
tapData <- subset(tapData, Cluster_Location != "Oahu" & Cluster_Location != "Hawaii")

multilevel <- left_join(tapData, multivariate, by = "Cluster_Location")
multilevel <- subset(multilevel, !is.na(precip))
#huge variation in values ALAND and AWATER, so doing a log transformation to normalize the data. 
multilevel$landlog <- log(multilevel$total_area)
multilevel$waterlog <- log(multilevel$total_water)
multilevel <- multilevel %>% 
  dplyr::select(d18O, d_ex, landlog, waterlog, elevation_range, streamflow, precip, 
         popdensity, medincome)
```

Exploring our R2 if we just throw everything in, with d18O and d_ex as dependent variables. 

```{r lm}
lm1 <- lm(multilevel,formula = cbind(d18O, d_ex) ~.)
summary(lm1)
```
 While we have significant relationships when including all predictors (p <0.05), d_ex has a much lower adjusted R2 at 0.162 compared to the Adjusted R2 of 0.7376. This is a pretty good model! But let's see if we can make it better using suggestions from the leaps package. 
 
```{r Regsubset}
Best_Subset <- regsubsets(d18O ~ landlog + waterlog + elevation_range + streamflow + 
    precip + popdensity + medincome,
               data = multilevel,
               nbest = 1,      # 1 best model for each number of predictors
               nvmax = NULL,    # NULL for no limit on number of variables
               force.in = NULL,
               force.out = NULL,
               method = "exhaustive")
summary_best_subset <- summary(Best_Subset)
as.data.frame(summary_best_subset$outmat)
```
leaps recommends ```which.max(summary_best_subset$adjr2)``` in our dataset (four). 


You can see in the dataframe that, in order, the best predictors in include are:
* elevation
* landlog
* precip
* medincome

The recommended ones can be viewed using "summary_best_subset$which[4,]"

So, running our model with the best predictors
```{r bestModel}
best.model <- lm(d18O ~ landlog + elevation_range + precip + medincome, data = multilevel)
summary(best.model)
```

When we run the adjusted model our adjusted R2 goes up...by 0.0002. Uhhhh might be fine just running our base model. 

Actually, we're best off when we simply run d18O without d_ex, getting an R2 of 0.7821
```{r lm}
multilevel2 <- multilevel[ -c(2) ]
lm2 <- lm(multilevel2,formula = cbind(d18O) ~.)
summary(lm2)
```